<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css">


  <meta name="keywords" content="computer vision,">








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.2">






<meta name="description" content="Mask R-CNN for Object Detection and SegmentationThis is an implementation of Mask R-CNN on Python 3, Keras, and TensorFlow. The model generates bounding boxes and segmentation masks for each instance">
<meta name="keywords" content="computer vision">
<meta property="og:type" content="article">
<meta property="og:title" content="mask-rcnn">
<meta property="og:url" content="http://yoursite.com/2018/11/25/mask-rcnn/index.html">
<meta property="og:site_name" content="霍俊毅">
<meta property="og:description" content="Mask R-CNN for Object Detection and SegmentationThis is an implementation of Mask R-CNN on Python 3, Keras, and TensorFlow. The model generates bounding boxes and segmentation masks for each instance">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://yoursite.com/2018/11/25/mask-rcnn/assets/street.png">
<meta property="og:image" content="http://yoursite.com/2018/11/25/mask-rcnn/assets/detection_anchors.png">
<meta property="og:image" content="http://yoursite.com/2018/11/25/mask-rcnn/assets/detection_refinement.png">
<meta property="og:image" content="http://yoursite.com/2018/11/25/mask-rcnn/assets/detection_masks.png">
<meta property="og:image" content="http://yoursite.com/2018/11/25/mask-rcnn/assets/detection_activations.png">
<meta property="og:image" content="http://yoursite.com/2018/11/25/mask-rcnn/assets/detection_histograms.png">
<meta property="og:image" content="http://yoursite.com/2018/11/25/mask-rcnn/assets/detection_tensorboard.png">
<meta property="og:image" content="http://yoursite.com/2018/11/25/mask-rcnn/assets/detection_final.png">
<meta property="og:image" content="http://yoursite.com/2018/11/25/mask-rcnn/assets/4k_video.gif">
<meta property="og:image" content="http://yoursite.com/2018/11/25/mask-rcnn/assets/images_to_osm.png">
<meta property="og:image" content="http://yoursite.com/2018/11/25/mask-rcnn/assets/balloon_color_splash.gif">
<meta property="og:image" content="http://yoursite.com/2018/11/25/mask-rcnn/assets/nucleus_segmentation.png">
<meta property="og:image" content="https://github.com/SUYEgit/Surgery-Robot-Detection-Segmentation/raw/master/assets/video.gif">
<meta property="og:image" content="http://yoursite.com/2018/11/25/mask-rcnn/assets/project_3dbuildings.png">
<meta property="og:image" content="http://yoursite.com/2018/11/25/mask-rcnn/assets/project_usiigaci1.gif">
<meta property="og:image" content="http://yoursite.com/2018/11/25/mask-rcnn/assets/project_usiigaci2.gif">
<meta property="og:image" content="http://yoursite.com/2018/11/25/mask-rcnn/assets/project_ice_wedge_polygons.png">
<meta property="og:image" content="http://yoursite.com/2018/11/25/mask-rcnn/assets/project_shiny1.jpg">
<meta property="og:image" content="http://yoursite.com/2018/11/25/mask-rcnn/assets/mapping_challenge.png">
<meta property="og:image" content="http://yoursite.com/2018/11/25/mask-rcnn/assets/project_grass_gis.png">
<meta property="og:updated_time" content="2018-11-26T05:45:15.691Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="mask-rcnn">
<meta name="twitter:description" content="Mask R-CNN for Object Detection and SegmentationThis is an implementation of Mask R-CNN on Python 3, Keras, and TensorFlow. The model generates bounding boxes and segmentation masks for each instance">
<meta name="twitter:image" content="http://yoursite.com/2018/11/25/mask-rcnn/assets/street.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2018/11/25/mask-rcnn/">





  <title>mask-rcnn | 霍俊毅</title><!-- hexo-inject:begin --><!-- hexo-inject:end -->
  














</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">霍俊毅</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Huo Junyi</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/11/25/mask-rcnn/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="霍俊毅">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/kitten2.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="霍俊毅">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">mask-rcnn</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-11-25T22:19:15+08:00">
                2018-11-25
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/11/25/mask-rcnn/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/11/25/mask-rcnn/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2018/11/25/mask-rcnn/" class="leancloud_visitors" data-flag-title="mask-rcnn">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="Mask-R-CNN-for-Object-Detection-and-Segmentation"><a href="#Mask-R-CNN-for-Object-Detection-and-Segmentation" class="headerlink" title="Mask R-CNN for Object Detection and Segmentation"></a><a href="https://github.com/matterport/Mask_RCNN" target="_blank" rel="noopener">Mask R-CNN for Object Detection and Segmentation</a></h1><p>This is an implementation of <a href="https://arxiv.org/abs/1703.06870" target="_blank" rel="noopener">Mask R-CNN</a> on Python 3, Keras, and TensorFlow. The model generates bounding boxes and segmentation masks for each instance of an object in the image. It’s based on Feature Pyramid Network (FPN) and a ResNet101 backbone.</p>
<p><img src="assets/street.png" alt="Instance Segmentation Sample"></p>
<p>The repository includes:</p>
<ul>
<li>Source code of Mask R-CNN built on FPN and ResNet101.</li>
<li>Training code for MS COCO</li>
<li>Pre-trained weights for MS COCO</li>
<li>Jupyter notebooks to visualize the detection pipeline at every step</li>
<li>ParallelModel class for multi-GPU training</li>
<li>Evaluation on MS COCO metrics (AP)</li>
<li>Example of training on your own dataset</li>
</ul>
<p>The code is documented and designed to be easy to extend. If you use it in your research, please consider citing this repository (bibtex below). If you work on 3D vision, you might find our recently released <a href="https://matterport.com/blog/2017/09/20/announcing-matterport3d-research-dataset/" target="_blank" rel="noopener">Matterport3D</a> dataset useful as well.<br>This dataset was created from 3D-reconstructed spaces captured by our customers who agreed to make them publicly available for academic use. You can see more examples <a href="https://matterport.com/gallery/" target="_blank" rel="noopener">here</a>.</p>
<a id="more"></a>
<h1 id="Getting-Started"><a href="#Getting-Started" class="headerlink" title="Getting Started"></a>Getting Started</h1><ul>
<li><p><a href="samples/demo.ipynb">demo.ipynb</a> Is the easiest way to start. It shows an example of using a model pre-trained on MS COCO to segment objects in your own images.<br>It includes code to run object detection and instance segmentation on arbitrary images.</p>
</li>
<li><p><a href="samples/shapes/train_shapes.ipynb">train_shapes.ipynb</a> shows how to train Mask R-CNN on your own dataset. This notebook introduces a toy dataset (Shapes) to demonstrate training on a new dataset.</p>
</li>
<li><p>(<a href="mrcnn/model.py">model.py</a>, <a href="mrcnn/utils.py">utils.py</a>, <a href="mrcnn/config.py">config.py</a>): These files contain the main Mask RCNN implementation. </p>
</li>
</ul>
<ul>
<li><p><a href="samples/coco/inspect_data.ipynb">inspect_data.ipynb</a>. This notebook visualizes the different pre-processing steps<br>to prepare the training data.</p>
</li>
<li><p><a href="samples/coco/inspect_model.ipynb">inspect_model.ipynb</a> This notebook goes in depth into the steps performed to detect and segment objects. It provides visualizations of every step of the pipeline.</p>
</li>
<li><p><a href="samples/coco/inspect_weights.ipynb">inspect_weights.ipynb</a><br>This notebooks inspects the weights of a trained model and looks for anomalies and odd patterns.</p>
</li>
</ul>
<h1 id="Step-by-Step-Detection"><a href="#Step-by-Step-Detection" class="headerlink" title="Step by Step Detection"></a>Step by Step Detection</h1><p>To help with debugging and understanding the model, there are 3 notebooks<br>(<a href="samples/coco/inspect_data.ipynb">inspect_data.ipynb</a>, <a href="samples/coco/inspect_model.ipynb">inspect_model.ipynb</a>,<br><a href="samples/coco/inspect_weights.ipynb">inspect_weights.ipynb</a>) that provide a lot of visualizations and allow running the model step by step to inspect the output at each point. Here are a few examples:</p>
<h2 id="1-Anchor-sorting-and-filtering"><a href="#1-Anchor-sorting-and-filtering" class="headerlink" title="1. Anchor sorting and filtering"></a>1. Anchor sorting and filtering</h2><p>Visualizes every step of the first stage Region Proposal Network and displays positive and negative anchors along with anchor box refinement.<br><img src="assets/detection_anchors.png" alt=""></p>
<h2 id="2-Bounding-Box-Refinement"><a href="#2-Bounding-Box-Refinement" class="headerlink" title="2. Bounding Box Refinement"></a>2. Bounding Box Refinement</h2><p>This is an example of final detection boxes (dotted lines) and the refinement applied to them (solid lines) in the second stage.<br><img src="assets/detection_refinement.png" alt=""></p>
<h2 id="3-Mask-Generation"><a href="#3-Mask-Generation" class="headerlink" title="3. Mask Generation"></a>3. Mask Generation</h2><p>Examples of generated masks. These then get scaled and placed on the image in the right location.</p>
<p><img src="assets/detection_masks.png" alt=""></p>
<h2 id="4-Layer-activations"><a href="#4-Layer-activations" class="headerlink" title="4.Layer activations"></a>4.Layer activations</h2><p>Often it’s useful to inspect the activations at different layers to look for signs of trouble (all zeros or random noise).</p>
<p><img src="assets/detection_activations.png" alt=""></p>
<h2 id="5-Weight-Histograms"><a href="#5-Weight-Histograms" class="headerlink" title="5. Weight Histograms"></a>5. Weight Histograms</h2><p>Another useful debugging tool is to inspect the weight histograms. These are included in the inspect_weights.ipynb notebook.</p>
<p><img src="assets/detection_histograms.png" alt=""></p>
<h2 id="6-Logging-to-TensorBoard"><a href="#6-Logging-to-TensorBoard" class="headerlink" title="6. Logging to TensorBoard"></a>6. Logging to TensorBoard</h2><p>TensorBoard is another great debugging and visualization tool. The model is configured to log losses and save weights at the end of every epoch.</p>
<p><img src="assets/detection_tensorboard.png" alt=""></p>
<h2 id="6-Composing-the-different-pieces-into-a-final-result"><a href="#6-Composing-the-different-pieces-into-a-final-result" class="headerlink" title="6. Composing the different pieces into a final result"></a>6. Composing the different pieces into a final result</h2><p><img src="assets/detection_final.png" alt=""></p>
<h1 id="Training-on-MS-COCO"><a href="#Training-on-MS-COCO" class="headerlink" title="Training on MS COCO"></a>Training on MS COCO</h1><p>We’re providing pre-trained weights for MS COCO to make it easier to start. You can<br>use those weights as a starting point to train your own variation on the network.<br>Training and evaluation code is in <code>samples/coco/coco.py</code>. You can import this<br>module in Jupyter notebook (see the provided notebooks for examples) or you<br>can run it directly from the command line as such:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># Train a new model starting from pre-trained COCO weights</span><br><span class="line">python3 samples/coco/coco.py train --dataset=/path/to/coco/ --model=coco</span><br><span class="line"></span><br><span class="line"># Train a new model starting from ImageNet weights</span><br><span class="line">python3 samples/coco/coco.py train --dataset=/path/to/coco/ --model=imagenet</span><br><span class="line"></span><br><span class="line"># Continue training a model that you had trained earlier</span><br><span class="line">python3 samples/coco/coco.py train --dataset=/path/to/coco/ --model=/path/to/weights.h5</span><br><span class="line"></span><br><span class="line"># Continue training the last model you trained. This will find</span><br><span class="line"># the last trained weights in the model directory.</span><br><span class="line">python3 samples/coco/coco.py train --dataset=/path/to/coco/ --model=last</span><br></pre></td></tr></table></figure>
<p>You can also run the COCO evaluation code with:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># Run COCO evaluation on the last trained model</span><br><span class="line">python3 samples/coco/coco.py evaluate --dataset=/path/to/coco/ --model=last</span><br></pre></td></tr></table></figure></p>
<p>The training schedule, learning rate, and other parameters should be set in <code>samples/coco/coco.py</code>.</p>
<h1 id="Training-on-Your-Own-Dataset"><a href="#Training-on-Your-Own-Dataset" class="headerlink" title="Training on Your Own Dataset"></a>Training on Your Own Dataset</h1><p>Start by reading this <a href="https://engineering.matterport.com/splash-of-color-instance-segmentation-with-mask-r-cnn-and-tensorflow-7c761e238b46" target="_blank" rel="noopener">blog post about the balloon color splash sample</a>. It covers the process starting from annotating images to training to using the results in a sample application.</p>
<p>In summary, to train the model on your own dataset you’ll need to extend two classes:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">This class contains the default configuration. Subclass it and modify the attributes you need to change.</span><br><span class="line"></span><br><span class="line">```Dataset</span><br></pre></td></tr></table></figure>
<p>This class provides a consistent way to work with any dataset.<br>It allows you to use new datasets for training without having to change<br>the code of the model. It also supports loading multiple datasets at the<br>same time, which is useful if the objects you want to detect are not<br>all available in one dataset. </p>
<p>See examples in <code>samples/shapes/train_shapes.ipynb</code>, <code>samples/coco/coco.py</code>, <code>samples/balloon/balloon.py</code>, and <code>samples/nucleus/nucleus.py</code>.</p>
<h2 id="Differences-from-the-Official-Paper"><a href="#Differences-from-the-Official-Paper" class="headerlink" title="Differences from the Official Paper"></a>Differences from the Official Paper</h2><p>This implementation follows the Mask RCNN paper for the most part, but there are a few cases where we deviated in favor of code simplicity and generalization. These are some of the differences we’re aware of. If you encounter other differences, please do let us know.</p>
<ul>
<li><strong>Image Resizing:</strong> To support training multiple images per batch we resize all images to the same size. For example, 1024x1024px on MS COCO. We preserve the aspect ratio, so if an image is not square we pad it with zeros. In the paper the resizing is done such that the smallest side is 800px and the largest is trimmed at 1000px.</li>
<li><p><strong>Bounding Boxes</strong>: Some datasets provide bounding boxes and some provide masks only. To support training on multiple datasets we opted to ignore the bounding boxes that come with the dataset and generate them on the fly instead. We pick the smallest box that encapsulates all the pixels of the mask as the bounding box. This simplifies the implementation and also makes it easy to apply image augmentations that would otherwise be harder to apply to bounding boxes, such as image rotation.</p>
<p>  To validate this approach, we compared our computed bounding boxes to those provided by the COCO dataset.<br>We found that ~2% of bounding boxes differed by 1px or more, ~0.05% differed by 5px or more,<br>and only 0.01% differed by 10px or more.</p>
</li>
<li><p><strong>Learning Rate:</strong> The paper uses a learning rate of 0.02, but we found that to be<br>too high, and often causes the weights to explode, especially when using a small batch<br>size. It might be related to differences between how Caffe and TensorFlow compute<br>gradients (sum vs mean across batches and GPUs). Or, maybe the official model uses gradient<br>clipping to avoid this issue. We do use gradient clipping, but don’t set it too aggressively.<br>We found that smaller learning rates converge faster anyway so we go with that.</p>
</li>
</ul>
<h2 id="Citation"><a href="#Citation" class="headerlink" title="Citation"></a>Citation</h2><p>Use this bibtex to cite this repository:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">@misc&#123;matterport_maskrcnn_2017,</span><br><span class="line">  title=&#123;Mask R-CNN for object detection and instance segmentation on Keras and TensorFlow&#125;,</span><br><span class="line">  author=&#123;Waleed Abdulla&#125;,</span><br><span class="line">  year=&#123;2017&#125;,</span><br><span class="line">  publisher=&#123;Github&#125;,</span><br><span class="line">  journal=&#123;GitHub repository&#125;,</span><br><span class="line">  howpublished=&#123;\url&#123;https://github.com/matterport/Mask_RCNN&#125;&#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="Contributing"><a href="#Contributing" class="headerlink" title="Contributing"></a>Contributing</h2><p>Contributions to this repository are welcome. Examples of things you can contribute:</p>
<ul>
<li>Speed Improvements. Like re-writing some Python code in TensorFlow or Cython.</li>
<li>Training on other datasets.</li>
<li>Accuracy Improvements.</li>
<li>Visualizations and examples.</li>
</ul>
<p>You can also <a href="https://matterport.com/careers/" target="_blank" rel="noopener">join our team</a> and help us build even more projects like this one.</p>
<h2 id="Requirements"><a href="#Requirements" class="headerlink" title="Requirements"></a>Requirements</h2><p>Python 3.4, TensorFlow 1.3, Keras 2.0.8 and other common packages listed in <code>requirements.txt</code>.</p>
<h3 id="MS-COCO-Requirements"><a href="#MS-COCO-Requirements" class="headerlink" title="MS COCO Requirements:"></a>MS COCO Requirements:</h3><p>To train or test on MS COCO, you’ll also need:</p>
<ul>
<li>pycocotools (installation instructions below)</li>
<li><a href="http://cocodataset.org/#home" target="_blank" rel="noopener">MS COCO Dataset</a></li>
<li>Download the 5K <a href="https://dl.dropboxusercontent.com/s/o43o90bna78omob/instances_minival2014.json.zip?dl=0" target="_blank" rel="noopener">minival</a><br>and the 35K <a href="https://dl.dropboxusercontent.com/s/s3tw5zcg7395368/instances_valminusminival2014.json.zip?dl=0" target="_blank" rel="noopener">validation-minus-minival</a><br>subsets. More details in the original <a href="https://github.com/rbgirshick/py-faster-rcnn/blob/master/data/README.md" target="_blank" rel="noopener">Faster R-CNN implementation</a>.</li>
</ul>
<p>If you use Docker, the code has been verified to work on<br><a href="https://hub.docker.com/r/waleedka/modern-deep-learning/" target="_blank" rel="noopener">this Docker container</a>.</p>
<h2 id="Installation"><a href="#Installation" class="headerlink" title="Installation"></a>Installation</h2><ol>
<li><p>Install dependencies</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip3 install -r requirements.txt</span><br></pre></td></tr></table></figure>
</li>
<li><p>Clone this repository</p>
</li>
<li>Run setup from the repository root directory<pre><code class="bash">python3 setup.py install
</code></pre>
</li>
<li>Download pre-trained COCO weights (mask_rcnn_coco.h5) from the <a href="https://github.com/matterport/Mask_RCNN/releases" target="_blank" rel="noopener">releases page</a>.</li>
<li><p>(Optional) To train or test on MS COCO install <code>pycocotools</code> from one of these repos. They are forks of the original pycocotools with fixes for Python3 and Windows (the official repo doesn’t seem to be active anymore).</p>
<ul>
<li>Linux: <a href="https://github.com/waleedka/coco" target="_blank" rel="noopener">https://github.com/waleedka/coco</a></li>
<li>Windows: <a href="https://github.com/philferriere/cocoapi" target="_blank" rel="noopener">https://github.com/philferriere/cocoapi</a>.<br>You must have the Visual C++ 2015 build tools on your path (see the repo for additional details)</li>
</ul>
</li>
</ol>
<h1 id="Projects-Using-this-Model"><a href="#Projects-Using-this-Model" class="headerlink" title="Projects Using this Model"></a>Projects Using this Model</h1><p>If you extend this model to other datasets or build projects that use it, we’d love to hear from you.</p>
<h3 id="4K-Video-Demo-by-Karol-Majek"><a href="#4K-Video-Demo-by-Karol-Majek" class="headerlink" title="4K Video Demo by Karol Majek."></a><a href="https://www.youtube.com/watch?v=OOT3UIXZztE" target="_blank" rel="noopener">4K Video Demo</a> by Karol Majek.</h3><p><a href="https://www.youtube.com/watch?v=OOT3UIXZztE" target="_blank" rel="noopener"><img src="assets/4k_video.gif" alt="Mask RCNN on 4K Video"></a></p>
<h3 id="Images-to-OSM-Improve-OpenStreetMap-by-adding-baseball-soccer-tennis-football-and-basketball-fields"><a href="#Images-to-OSM-Improve-OpenStreetMap-by-adding-baseball-soccer-tennis-football-and-basketball-fields" class="headerlink" title="Images to OSM: Improve OpenStreetMap by adding baseball, soccer, tennis, football, and basketball fields."></a><a href="https://github.com/jremillard/images-to-osm" target="_blank" rel="noopener">Images to OSM</a>: Improve OpenStreetMap by adding baseball, soccer, tennis, football, and basketball fields.</h3><p><img src="assets/images_to_osm.png" alt="Identify sport fields in satellite images"></p>
<h3 id="Splash-of-Color-A-blog-post-explaining-how-to-train-this-model-from-scratch-and-use-it-to-implement-a-color-splash-effect"><a href="#Splash-of-Color-A-blog-post-explaining-how-to-train-this-model-from-scratch-and-use-it-to-implement-a-color-splash-effect" class="headerlink" title="Splash of Color. A blog post explaining how to train this model from scratch and use it to implement a color splash effect."></a><a href="https://engineering.matterport.com/splash-of-color-instance-segmentation-with-mask-r-cnn-and-tensorflow-7c761e238b46" target="_blank" rel="noopener">Splash of Color</a>. A blog post explaining how to train this model from scratch and use it to implement a color splash effect.</h3><p><img src="assets/balloon_color_splash.gif" alt="Balloon Color Splash"></p>
<h3 id="Segmenting-Nuclei-in-Microscopy-Images-Built-for-the-2018-Data-Science-Bowl"><a href="#Segmenting-Nuclei-in-Microscopy-Images-Built-for-the-2018-Data-Science-Bowl" class="headerlink" title="Segmenting Nuclei in Microscopy Images. Built for the 2018 Data Science Bowl"></a><a href="samples/nucleus">Segmenting Nuclei in Microscopy Images</a>. Built for the <a href="https://www.kaggle.com/c/data-science-bowl-2018" target="_blank" rel="noopener">2018 Data Science Bowl</a></h3><p>Code is in the <code>samples/nucleus</code> directory.</p>
<p><img src="assets/nucleus_segmentation.png" alt="Nucleus Segmentation"></p>
<h3 id="Detection-and-Segmentation-for-Surgery-Robots-by-the-NUS-Control-amp-Mechatronics-Lab"><a href="#Detection-and-Segmentation-for-Surgery-Robots-by-the-NUS-Control-amp-Mechatronics-Lab" class="headerlink" title="Detection and Segmentation for Surgery Robots by the NUS Control &amp; Mechatronics Lab."></a><a href="https://github.com/SUYEgit/Surgery-Robot-Detection-Segmentation" target="_blank" rel="noopener">Detection and Segmentation for Surgery Robots</a> by the NUS Control &amp; Mechatronics Lab.</h3><p><img src="https://github.com/SUYEgit/Surgery-Robot-Detection-Segmentation/raw/master/assets/video.gif" alt="Surgery Robot Detection and Segmentation"></p>
<h3 id="Reconstructing-3D-buildings-from-aerial-LiDAR"><a href="#Reconstructing-3D-buildings-from-aerial-LiDAR" class="headerlink" title="Reconstructing 3D buildings from aerial LiDAR"></a><a href="https://medium.com/geoai/reconstructing-3d-buildings-from-aerial-lidar-with-ai-details-6a81cb3079c0" target="_blank" rel="noopener">Reconstructing 3D buildings from aerial LiDAR</a></h3><p>A proof of concept project by <a href="https://www.esri.com/" target="_blank" rel="noopener">Esri</a>, in collaboration with Nvidia and Miami-Dade County. Along with a great write up and code by Dmitry Kudinov, Daniel Hedges, and Omar Maher.<br><img src="assets/project_3dbuildings.png" alt="3D Building Reconstruction"></p>
<h3 id="Usiigaci-Label-free-Cell-Tracking-in-Phase-Contrast-Microscopy"><a href="#Usiigaci-Label-free-Cell-Tracking-in-Phase-Contrast-Microscopy" class="headerlink" title="Usiigaci: Label-free Cell Tracking in Phase Contrast Microscopy"></a><a href="https://github.com/oist/usiigaci" target="_blank" rel="noopener">Usiigaci: Label-free Cell Tracking in Phase Contrast Microscopy</a></h3><p>A project from Japan to automatically track cells in a microfluidics platform. Paper is pending, but the source code is released.</p>
<p><img src="assets/project_usiigaci1.gif" alt=""> <img src="assets/project_usiigaci2.gif" alt=""></p>
<h3 id="Characterization-of-Arctic-Ice-Wedge-Polygons-in-Very-High-Spatial-Resolution-Aerial-Imagery"><a href="#Characterization-of-Arctic-Ice-Wedge-Polygons-in-Very-High-Spatial-Resolution-Aerial-Imagery" class="headerlink" title="Characterization of Arctic Ice-Wedge Polygons in Very High Spatial Resolution Aerial Imagery"></a><a href="http://www.mdpi.com/2072-4292/10/9/1487" target="_blank" rel="noopener">Characterization of Arctic Ice-Wedge Polygons in Very High Spatial Resolution Aerial Imagery</a></h3><p>Research project to understand the complex processes between degradations in the Arctic and climate change. By Weixing Zhang, Chandi Witharana, Anna Liljedahl, and Mikhail Kanevskiy.<br><img src="assets/project_ice_wedge_polygons.png" alt="image"></p>
<h3 id="Mask-RCNN-Shiny"><a href="#Mask-RCNN-Shiny" class="headerlink" title="Mask-RCNN Shiny"></a><a href="https://github.com/huuuuusy/Mask-RCNN-Shiny" target="_blank" rel="noopener">Mask-RCNN Shiny</a></h3><p>A computer vision class project by HU Shiyu to apply the color pop effect on people with beautiful results.<br><img src="assets/project_shiny1.jpg" alt=""></p>
<h3 id="Mapping-Challenge-Convert-satellite-imagery-to-maps-for-use-by-humanitarian-organisations"><a href="#Mapping-Challenge-Convert-satellite-imagery-to-maps-for-use-by-humanitarian-organisations" class="headerlink" title="Mapping Challenge: Convert satellite imagery to maps for use by humanitarian organisations."></a><a href="https://github.com/crowdAI/crowdai-mapping-challenge-mask-rcnn" target="_blank" rel="noopener">Mapping Challenge</a>: Convert satellite imagery to maps for use by humanitarian organisations.</h3><p><img src="assets/mapping_challenge.png" alt="Mapping Challenge"></p>
<h3 id="GRASS-GIS-Addon-to-generate-vector-masks-from-geospatial-imagery-Based-on-a-Master’s-thesis-by-Ondrej-Pesek"><a href="#GRASS-GIS-Addon-to-generate-vector-masks-from-geospatial-imagery-Based-on-a-Master’s-thesis-by-Ondrej-Pesek" class="headerlink" title="GRASS GIS Addon to generate vector masks from geospatial imagery. Based on a Master’s thesis by Ondřej Pešek."></a><a href="https://github.com/ctu-geoforall-lab/i.ann.maskrcnn" target="_blank" rel="noopener">GRASS GIS Addon</a> to generate vector masks from geospatial imagery. Based on a <a href="https://github.com/ctu-geoforall-lab-projects/dp-pesek-2018" target="_blank" rel="noopener">Master’s thesis</a> by Ondřej Pešek.</h3><p><img src="assets/project_grass_gis.png" alt="GRASS GIS Image"></p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/computer-vision/" rel="tag"># computer vision</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/11/25/hello-world/" rel="next" title="Hello World">
                <i class="fa fa-chevron-left"></i> Hello World
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/11/25/faceswap/" rel="prev" title="faceswap">
                faceswap <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image" src="/images/kitten2.jpg" alt="霍俊毅">
          <p class="site-author-name" itemprop="name">霍俊毅</p>
           
              <p class="site-description motion-element" itemprop="description">霍俊毅's blog</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">10</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">5</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://cn.linkedin.com/in/%E4%BF%8A%E6%AF%85-%E9%9C%8D-605041109" target="_blank" title="Linkedin">
                  
                    <i class="fa fa-fw fa-linkedin"></i>
                  
                    
                      Linkedin
                    
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://github.com/JyiHUO" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                    
                      GitHub
                    
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.zhihu.com/people/bissbiss/activities" target="_blank" title="知乎">
                  
                    <i class="fa fa-fw fa-book"></i>
                  
                    
                      知乎
                    
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://stackoverflow.com/users/6080827/rachel-jennifer" target="_blank" title="StackOverflow">
                  
                    <i class="fa fa-fw fa-stack-overflow"></i>
                  
                    
                      StackOverflow
                    
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Mask-R-CNN-for-Object-Detection-and-Segmentation"><span class="nav-number">1.</span> <span class="nav-text">Mask R-CNN for Object Detection and Segmentation</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Getting-Started"><span class="nav-number">2.</span> <span class="nav-text">Getting Started</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Step-by-Step-Detection"><span class="nav-number">3.</span> <span class="nav-text">Step by Step Detection</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-Anchor-sorting-and-filtering"><span class="nav-number">3.1.</span> <span class="nav-text">1. Anchor sorting and filtering</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-Bounding-Box-Refinement"><span class="nav-number">3.2.</span> <span class="nav-text">2. Bounding Box Refinement</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-Mask-Generation"><span class="nav-number">3.3.</span> <span class="nav-text">3. Mask Generation</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-Layer-activations"><span class="nav-number">3.4.</span> <span class="nav-text">4.Layer activations</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-Weight-Histograms"><span class="nav-number">3.5.</span> <span class="nav-text">5. Weight Histograms</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-Logging-to-TensorBoard"><span class="nav-number">3.6.</span> <span class="nav-text">6. Logging to TensorBoard</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-Composing-the-different-pieces-into-a-final-result"><span class="nav-number">3.7.</span> <span class="nav-text">6. Composing the different pieces into a final result</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Training-on-MS-COCO"><span class="nav-number">4.</span> <span class="nav-text">Training on MS COCO</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Training-on-Your-Own-Dataset"><span class="nav-number">5.</span> <span class="nav-text">Training on Your Own Dataset</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Differences-from-the-Official-Paper"><span class="nav-number">5.1.</span> <span class="nav-text">Differences from the Official Paper</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Citation"><span class="nav-number">5.2.</span> <span class="nav-text">Citation</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Contributing"><span class="nav-number">5.3.</span> <span class="nav-text">Contributing</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Requirements"><span class="nav-number">5.4.</span> <span class="nav-text">Requirements</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#MS-COCO-Requirements"><span class="nav-number">5.4.1.</span> <span class="nav-text">MS COCO Requirements:</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Installation"><span class="nav-number">5.5.</span> <span class="nav-text">Installation</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Projects-Using-this-Model"><span class="nav-number">6.</span> <span class="nav-text">Projects Using this Model</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4K-Video-Demo-by-Karol-Majek"><span class="nav-number">6.0.1.</span> <span class="nav-text">4K Video Demo by Karol Majek.</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Images-to-OSM-Improve-OpenStreetMap-by-adding-baseball-soccer-tennis-football-and-basketball-fields"><span class="nav-number">6.0.2.</span> <span class="nav-text">Images to OSM: Improve OpenStreetMap by adding baseball, soccer, tennis, football, and basketball fields.</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Splash-of-Color-A-blog-post-explaining-how-to-train-this-model-from-scratch-and-use-it-to-implement-a-color-splash-effect"><span class="nav-number">6.0.3.</span> <span class="nav-text">Splash of Color. A blog post explaining how to train this model from scratch and use it to implement a color splash effect.</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Segmenting-Nuclei-in-Microscopy-Images-Built-for-the-2018-Data-Science-Bowl"><span class="nav-number">6.0.4.</span> <span class="nav-text">Segmenting Nuclei in Microscopy Images. Built for the 2018 Data Science Bowl</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Detection-and-Segmentation-for-Surgery-Robots-by-the-NUS-Control-amp-Mechatronics-Lab"><span class="nav-number">6.0.5.</span> <span class="nav-text">Detection and Segmentation for Surgery Robots by the NUS Control &amp; Mechatronics Lab.</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Reconstructing-3D-buildings-from-aerial-LiDAR"><span class="nav-number">6.0.6.</span> <span class="nav-text">Reconstructing 3D buildings from aerial LiDAR</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Usiigaci-Label-free-Cell-Tracking-in-Phase-Contrast-Microscopy"><span class="nav-number">6.0.7.</span> <span class="nav-text">Usiigaci: Label-free Cell Tracking in Phase Contrast Microscopy</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Characterization-of-Arctic-Ice-Wedge-Polygons-in-Very-High-Spatial-Resolution-Aerial-Imagery"><span class="nav-number">6.0.8.</span> <span class="nav-text">Characterization of Arctic Ice-Wedge Polygons in Very High Spatial Resolution Aerial Imagery</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Mask-RCNN-Shiny"><span class="nav-number">6.0.9.</span> <span class="nav-text">Mask-RCNN Shiny</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Mapping-Challenge-Convert-satellite-imagery-to-maps-for-use-by-humanitarian-organisations"><span class="nav-number">6.0.10.</span> <span class="nav-text">Mapping Challenge: Convert satellite imagery to maps for use by humanitarian organisations.</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#GRASS-GIS-Addon-to-generate-vector-masks-from-geospatial-imagery-Based-on-a-Master’s-thesis-by-Ondrej-Pesek"><span class="nav-number">6.0.11.</span> <span class="nav-text">GRASS GIS Addon to generate vector masks from geospatial imagery. Based on a Master’s thesis by Ondřej Pešek.</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">霍俊毅</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.2"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  

    
      <script id="dsq-count-scr" src="https://huojunyi.disqus.com/count.js" async></script>
    

    
      <script type="text/javascript">
        var disqus_config = function () {
          this.page.url = 'http://yoursite.com/2018/11/25/mask-rcnn/';
          this.page.identifier = '2018/11/25/mask-rcnn/';
          this.page.title = 'mask-rcnn';
        };
        var d = document, s = d.createElement('script');
        s.src = 'https://huojunyi.disqus.com/embed.js';
        s.setAttribute('data-timestamp', '' + +new Date());
        (d.head || d.body).appendChild(s);
      </script>
    

  




	





  








  





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("cwbL3KxL2nst7Jjbij5Ap50x-gzGzoHsz", "8vYasv6zVkxozxXvPToD1XrX");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config("");
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->
  


  

  

</body>
</html>
